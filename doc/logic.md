# ゲームロジックの実装について

[logic in English](/doc/en/logic.md)

このドキュメントでは、ゲームロジックの実装について説明します。\
ここで指すゲームロジックとは、人狼ゲームのルールならびにその遂行に関わる処理全般を指します。

## 人狼ゲームのルール

### 役職、陣営、種族

人狼ゲームには、以下の役職が存在します。

| 役職   | 英語名    | 陣営     | 種族 | 特殊能力                                                     |
| ------ | --------- | -------- | ---- | ------------------------------------------------------------ |
| 人狼   | WEREWOLF  | 人狼陣営 | 人狼 | 襲撃フェーズにエージェントを1体投票する                      |
| 狂人   | POSSESSED | 人狼陣営 | 人間 | 人狼陣営の勝利が自身の勝利となる                             |
| 占い師 | SEER      | 市民陣営 | 人間 | 占いフェーズにエージェントを1体指定する                      |
| 騎士   | BODYGUARD | 市民陣営 | 人間 | 護衛フェーズにエージェントを1体指定する                      |
| 村人   | VILLAGER  | 市民陣営 | 人間 | なし                                                         |
| 霊媒師 | MEDIUM    | 市民陣営 | 人間 | 追放フェーズによって追放されたエージェントの種族を取得できる |

市民陣営の英語名は `VILLAGER` 、人狼陣営の英語名は`WEREWOLF`です。\
種族の人間の英語名は `HUMAN` 、人狼の英語名は `WEREWOLF` です。

詳細な実装については、[role.go](../model/role.go)を参照してください。

### 人数

#### 5人ゲーム

| 役職   | 人数 |
| ------ | ---- |
| 人狼   | 1    |
| 狂人   | 1    |
| 占い師 | 1    |
| 騎士   | 0    |
| 村人   | 2    |
| 霊媒師 | 0    |

#### 13人ゲーム

| 役職   | 人数 |
| ------ | ---- |
| 人狼   | 3    |
| 狂人   | 1    |
| 占い師 | 1    |
| 騎士   | 1    |
| 村人   | 6    |
| 霊媒師 | 1    |

### ゲームの流れ

ゲームの開始時に、全エージェントに対して `INITIALIZE` リクエストを送信します。

ゲームは[昼セクション](#昼セクション)と[夜セクション](#夜セクション)の2つのセクションに分かれています。\
0日目の[昼セクション](#昼セクション)から始まり、0日目の[夜セクション](#夜セクション)、1日目の[昼セクション](#昼セクション)、1日目の[夜セクション](#夜セクション)と続きます。

[夜セクション](#夜セクション)、[追放フェーズ](#追放フェーズ)、[襲撃フェーズ](#襲撃フェーズ)の終了時点で以下のいずれかの条件を満たす場合、ゲームは終了します。

- 種族が人狼の生存しているエージェントの数が種族が人間の生存しているエージェントの数と同じかそれ以上の場合: 人狼陣営の勝利
- 種族が人狼の生存しているエージェントの数が0の場合: 市民陣営の勝利
- ゲームを継続するエラーエージェントの最大割合以上のエージェントがエラー状態になった場合

ゲームの終了時に、全エージェントに対して `FINISH` リクエストを送信します。

#### 昼セクション

1. 昼セクションの開始時に、全エージェントに対して `DAILY_INITIALIZE` リクエストを送信します。
1. `setting.talk_on_first_day` が `true` かつ0日目に限り、[囁きフェーズ](#囁きフェーズ)が開始します。
1. [トークフェーズ](#トークフェーズ)が開始します。

#### 夜セクション

1. 夜セクションの開始時に、全エージェントに対して `DAILY_FINISH` リクエストを送信します。
2. `setting.talk_on_first_day` が `true` かつ0日目に限り、[囁きフェーズ](#囁きフェーズ)が開始します。
3. 0日目以外の場合は、[追放フェーズ](#追放フェーズ)を開始します。
4. [占いフェーズ](#占いフェーズ)を開始します。
5. 0日目以外の場合は、[囁きフェーズ](#囁きフェーズ)を開始します。
6. 0日目以外の場合は、[護衛フェーズ](#護衛フェーズ)を開始します。
7. 0日目以外の場合は、[襲撃フェーズ](#襲撃フェーズ)を開始します。

### フェーズについて

#### 囁きフェーズ

生存している人狼エージェント数が2未満である場合は、スキップされます。\
生存している人狼エージェント数が2以上である場合は、以下の処理をします。

[発言のターン処理について](#発言のターン処理について)を参照してください。

#### トークフェーズ

生存しているエージェント数が2未満である場合は、スキップされます。
生存しているエージェント数が2以上である場合は、以下の処理をします。

[発言のターン処理について](#発言のターン処理について)を参照してください。

#### 追放フェーズ

生存しているエージェントに対して、`VOTE` リクエストを送信します。\
エージェントからのレスポンスを受信します。\
受信したターゲットとなるエージェントが生存している有効票をカウントし、最多票を得たエージェントが1人の場合は、そのエージェントを追放します。\
最多票を得たエージェントが複数の場合は `setting.vote.max_count` の回数まで再度投票を行います。\
再度投票を行っても最多票を得たエージェントが複数の場合は、最後の投票で最多票を得たエージェントからランダムに1人を追放します。\
有効票がない場合はエージェントを追放しません。\
エージェントが追放された場合は、その結果を追放結果、霊能結果に設定します。

#### 占いフェーズ

生存している占い師に対して、`DIVINE` リクエストを送信します。\
エージェントからのレスポンスを受信します。\
受信したターゲットとなるエージェントの種族を占い結果に設定します。\
ターゲットが生存していない場合は設定しません。

#### 護衛フェーズ

生存している騎士に対して、`GUARD` リクエストを送信します。\
エージェントからのレスポンスを受信します。\
受信したターゲットとなるエージェントを護衛対象に設定します。\
ターゲットが生存していない場合は設定しません。\
ターゲットが自分自身の場合は設定しません。

#### 襲撃フェーズ

生存している人狼に対して、`ATTACK` リクエストを送信します。\
エージェントからのレスポンスを受信します。\
受信したターゲットとなるエージェントが生存しているかつ、エージェントが人狼陣営ではない有効票をカウントし、最多票を得たエージェントが1人の場合は、そのエージェントを襲撃します。\
最多票を得たエージェントが複数の場合は `setting.attack_vote.max_count` の回数まで再度投票を行います。\
再度投票を行っても最多票を得たエージェントが複数の場合かつ `setting.attack_vote.allow_no_target` が `false` の場合は、最後の投票で最多票を得たエージェントからランダムに1人を襲撃します。\
襲撃対象のエージェントが護衛されていない場合のみ、襲撃対象のエージェントを襲撃します。\
この時点において騎士が生存している場合にのみ、護衛が有効です。\
有効票がない場合はエージェントを襲撃しません。\
エージェントが襲撃された場合は、その結果を襲撃結果に設定します。

### 発言のターン処理について

囁きフェーズの場合は、`setting.whisper.max_count` の制限を使用します。\
トークフェーズの場合は、`setting.talk.max_count` の制限を使用します。

`max_length.base_length` の制限がある場合はその値を、ない場合は0を `base_length` とします。\
`max_length.per_agent` で初期化された残り文字数を `remain_length` とします。

生存している人狼エージェント(トークフェーズの場合は生存しているエージェント)をランダムに並び替えた順列を作成します。

#### `max_count.per_day` の回数まで以下の処理を繰り返します

順列の先頭から順にエージェントに対して、以下の処理を繰り返します。

エージェントの `max_count.per_agent` の残り回数が0の場合は、スキップします。\
エージェントの `remain_length` が0以下の場合は、スキップします。 (`remaining_length` が設定されていない場合は除きます。)\
エージェントに `WHISPER` リクエストを送信します。\
エージェントからの `WHISPER` リクエストを受信します。\
エラーが発生した場合は、スキップ発言に置換します。 (スキップカウントの増加は行いません。)\
スキップカウントが `game.skip.max_count` を超えた場合は、オーバー発言に置換します。\
発言がオーバーもしくはスキップではない場合は、スキップカウントをリセットします。\
[発言の文字数制限について](#発言の文字数制限について)の処理を行います。\
発言がオーバーである場合は、残り回数を0に設定します。

全エージェントの発言がオーバーである場合は、トークフェーズを終了します。

### 発言の文字数制限について

囁きフェーズの場合は、`setting.whisper.max_length` の制限を使用します。\
トークフェーズの場合は、`setting.talk.max_length` の制限を使用します。

発言がオーバー、スキップ、強制スキップでない場合に以下の処理を上から順に行います。

#### 1. `max_length.per_agent` もしくは `max_length.base_length` の制限がある場合

**1.a. メンション(`@エージェントの名前`)が含まれる場合**

最初に出現したメンションの `@` より手前の発言を `mention_before` とします。\
メンション(`@エージェントの名前`)が含まれる場合は、最初に出現したメンションの以降(エージェント名より後ろ)の発言を `mention_after` とします。\
`mention_before` を `base_length` + `remain_length` の文字数で制限します。\
`mention_before` の文字数 - `base_length` の値が正の値である場合、`remain_length` をその値で減算します。\
`mention_after` を `max_length.mention_length` + `remain_length` の文字数で制限します。\
`mention_after` の文字数 - `max_length.mention_length` の値が正の値である場合、`remain_length` をその値で減算します。\
`mention_before` とメンションと `mention_after` を結合したものを発言とします。

**1.b. メンション(`@エージェントの名前`)が含まれない場合**

発言を `base_length` + `remain_length` の文字数で制限します。\
発言の文字数 - `base_length` の値が正の値である場合、`remain_length` をその値で減算します。

#### 2. `max_length.per_talk` の制限がある場合

発言を `max_length.per_talk` の文字数で制限します。

#### 3. 発言の文字数が0の場合は、オーバー発言に置換します
